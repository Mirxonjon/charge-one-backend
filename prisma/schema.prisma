generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TransactionType {
  DEPOSIT
  CHARGE
  REFUND
}

enum TransactionStatus {
  SUCCESS
  PENDING
  FAILED
}

enum PaymentMethod {
  CLICK
  PAYME
  CARD
}


model Role {
  id    Int    @id @default(autoincrement())
  name  String @unique
  users User[]
}

model User {
  id             Int       @id @default(autoincrement())
  phone          String    @unique
  password       String?
  firstName      String?
  lastName       String?
  wasBorn        DateTime?
  isVerified     Boolean   @default(false)
  roleId         Int
  role           Role      @relation(fields: [roleId], references: [id])
  sessions       Session[]
  otpCodes       OtpCode[]
  userCars       UserCar[]
  Cars           Car[]
  Wallet         Wallet[]

  ChargingSession  ChargingSession[]
  resetTokens    PasswordResetToken[]
  registrationTokens RegistrationToken[]
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

model OtpCode {
  id            Int       @id @default(autoincrement())
  code          String
  phone         String
  userId        Int?
  user          User?     @relation(fields: [userId], references: [id])
  expiresAt     DateTime
  isUsed        Boolean   @default(false)
  attemptsCount Int       @default(0)
  createdAt     DateTime  @default(now())

  @@index([phone])
  @@index([userId])
}

model RegistrationToken {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  token     String   // hashed
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  token     String   // hashed
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
}

enum CarCreatedByType {
  ADMIN
  USER
  SYSTEM
}

model Car {
  id           Int       @id @default(autoincrement())
  createdById  Int?
  createdBy    User?     @relation(fields: [createdById], references: [id])
  createdByType CarCreatedByType @default(SYSTEM)

  brand        String
  model        String
  year         Int?
  vin          String?   @unique
  batterySize  Float?
  rangeKm      Int?
  imageUrl     String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  userCars     UserCar[]

  @@index([brand])
  @@index([model])
  @@index([year])
  @@index([createdByType])
  @@index([createdById])
}

model UserCar {
  id          Int      @id @default(autoincrement())
  userId      Int
  carId       Int
  plateNumber String?  @unique
  color       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
  car  Car  @relation(fields: [carId], references: [id])

  @@index([userId])
  @@index([carId])
}

model Session {
  id           Int       @id @default(autoincrement())
  userId       Int
  user         User      @relation(fields: [userId], references: [id])
  refreshToken String    // store hashed
  ipAddress    String?
  userAgent    String?
  expiresAt    DateTime
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([userId])
}

enum ConnectorStatus {
  AVAILABLE
  OCCUPIED
  OUT_OF_SERVICE
}

enum SessionStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

enum PayoutStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
}
enum StationPowerType {
  AC
  DC
  HYBRID
  ULTRA
}

model Operator {
  id           Int                @id @default(autoincrement())
  title        String
  color        String?
  contact      String?
  bankName     String?
  bankAccount  String?
  bankMfo      String?
  stations     ChargingStation[]
  payouts      OperatorPayout[]
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  @@index([title])
}

model ChargingStation {
  id           Int          @id @default(autoincrement())
  operatorId   Int
  operator     Operator     @relation(fields: [operatorId], references: [id])
  title        String
  address      String?
  latitude     Float
  longitude    Float
  powerType    StationPowerType
  isActive     Boolean      @default(true)
  workingHours String?
  Discount     Discount?
  connectors   Connector[]
  pricing      StationPricing?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([operatorId])
}

model Connector {
  id           Int               @id @default(autoincrement())
  stationId    Int
  station      ChargingStation   @relation(fields: [stationId], references: [id])
  type         String
  powerKw      Float
  status       ConnectorStatus   @default(AVAILABLE)
  sessions     ChargingSession[]
  statusLogs   ConnectorStatusLog[]
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  @@index([stationId])
}

model ConnectorStatusLog {
  id          Int              @id @default(autoincrement())
  connectorId Int
  connector   Connector        @relation(fields: [connectorId], references: [id])
  status      ConnectorStatus
  powerKw     Float?
  timestamp   DateTime         @default(now())
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([connectorId])
}

model StationPricing {
  id          Int      @id @default(autoincrement())
  stationId   Int      @unique 
  station     ChargingStation @relation(fields: [stationId], references: [id])
  pricePerKwh Float
  idleFee     Float?
  endTime     DateTime?
  createdAt   DateTime @default(now()) 
  updatedAt   DateTime @updatedAt

  @@index([stationId])
}

model ChargingSession {
  id          Int          @id @default(autoincrement())
  userId      Int
  user        User         @relation(fields: [userId], references: [id])
  connectorId Int
  connector   Connector    @relation(fields: [connectorId], references: [id])
  energyKwh   Float        @default(0)
  cost        Float        @default(0)
  status      SessionStatus @default(ACTIVE)
  startTime   DateTime      @default(now())
  endTime     DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  WalletTransaction WalletTransaction[]
  Payment           Payment[]  
  @@index([userId])
  @@index([connectorId])
}



model Wallet {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  user      User     @relation(fields: [userId], references: [id])
  balance   Decimal  @default(0)
  currency  String   @default("UZS")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  transactions WalletTransaction[]
}

model WalletTransaction {
  id        Int               @id @default(autoincrement())
  walletId  Int
  wallet    Wallet            @relation(fields: [walletId], references: [id])
  type      TransactionType
  amount    Decimal
  provider  String?
  sessionId Int?
  session   ChargingSession?  @relation(fields: [sessionId], references: [id])
  status    TransactionStatus @default(SUCCESS)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  @@index([walletId])
  @@index([sessionId])
}

model Payment {
  id        Int           @id @default(autoincrement())
  sessionId Int           @unique
  session   ChargingSession @relation(fields: [sessionId], references: [id])
  amount    Decimal
  method    PaymentMethod
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

model OperatorPayout { 
  id         Int          @id @default(autoincrement())
  operatorId Int
  operator   Operator     @relation(fields: [operatorId], references: [id])
  amount     Float
  currency   String       @default("USD")
  status     PayoutStatus @default(PENDING)
  periodFrom DateTime
  periodTo   DateTime
  paidAt     DateTime?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  @@index([operatorId])
}

model Discount {
  id          Int       @id @default(autoincrement())

  stationId   Int       @unique
  station     ChargingStation @relation(fields: [stationId], references: [id], onDelete: Cascade)

  percent     Float?     // percentage discount
  fixedPrice  Decimal?   @db.Decimal(10,2)

  startTime   DateTime
  endTime     DateTime

  isActive    Boolean    @default(true)

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([stationId])
}